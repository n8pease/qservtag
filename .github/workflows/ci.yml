# Qserv CI workflow
---
name: "CI"
on:
  push:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-run-image:
    name: Update Qserv image
    runs-on: ubuntu-20.04
    steps:
      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Install click
        run: |
          python -m pip install --upgrade pip
          pip install click pyyaml requests

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # 0 is "all history and branch tags"

      - name: Prepare user build image
        run: |
          ./admin/local/cli/qserv --log-level DEBUG build-user-build-image --build-image qserv/lite-build:2022.4.2-rc1-51-g474c66c0e \
          --group docker_outer

      - name: Build lite-qserv image
        run: |
          ./admin/local/cli/qserv --log-level DEBUG build --ref ${{github.ref_name}} \
          --pull-image \
          --push-image \
          --clang-format CHECK \
          -j2
        env:
          QSERV_DH_USER: ${{ secrets.FM_DOCKERHUB_TOKEN_USER }}
          QSERV_DH_TOKEN: ${{ secrets.FM_DOCKERHUB_TOKEN }}
