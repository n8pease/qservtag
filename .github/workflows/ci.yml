# Qserv CI workflow
---
name: "CI"
on:
  push:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-run-image:
    name: Update Qserv image
    runs-on: ubuntu-20.04
    outputs:
      build_image_name: ${{ steps.save_vars. }}
    steps:
      - name: Checkout code
        # run: git clone https://github.com/n8pease/qservtag.git .
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 0 is "all history and branch tags"

      - name: force update tags
        run: git fetch --force --tags
        # write about why this step is necessary, and include this link:
        # https://github.com/actions/checkout/issues/290

      - name: show tag with git-describe
        # run: git describe --always --tags
        run: git describe --always

      - name: show ref_name
        run: echo ${{github.ref_name}}

      - name: wait for the breaker to get checked in
        run: qserv wait 1

  and-then-fail:
    name: And Then Fail?
    runs-on: ubuntu-20.04
    needs: [update-run-image]
    steps:
      - name: Checkout code
        # run: git clone https://github.com/n8pease/qservtag.git .
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 0 is "all history and branch tags"

      - name: force update tags
        run: git fetch --force --tags
        # write about why this step is necessary, and include this link:
        # https://github.com/actions/checkout/issues/290

      - name: show tag with git-describe
        # run: git describe --always --tags
        run: git describe --always

      - name: show ref_name
        run: echo ${{github.ref_name}}

      - name: failer
        run: qserv fail
